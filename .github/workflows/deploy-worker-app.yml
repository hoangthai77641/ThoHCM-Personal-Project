name: Deploy Worker App to Firebase App Distribution

on:
  # Manual trigger only to avoid extra builds on every push
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type YES to confirm deploying to Firebase App Distribution'
        required: true
        default: 'NO'
      notes:
        description: 'Optional release notes (appended)'
        required: false
        default: ''

jobs:
  build-and-distribute:
    # Only allow the repository owner to run this job
    if: github.actor == github.repository_owner && inputs.confirm == 'YES'
    runs-on: ubuntu-latest
    environment:
      name: firebase-distribution
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.4'
        channel: 'stable'
        
    - name: Get dependencies
      run: |
        cd mobile/worker_app
        flutter pub get
        
    - name: Decode google-services.json (base64 â†’ json)
      run: |
        cd mobile/worker_app/android/app
        # Decode the base64 secret into a proper JSON file
        printf '%s' "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > google-services.json
        
    - name: Write Firebase service account to file
      run: |
        # Persist service account JSON to a file for the distribution action
        echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > firebase-service-account.json
        
    - name: Remove firebase_app_distribution from pubspec
      run: |
        cd mobile/worker_app
        # Temporarily remove firebase_app_distribution for build
        sed -i '/firebase_app_distribution:/d' pubspec.yaml
        flutter pub get
        
    - name: Build APK
      run: |
        cd mobile/worker_app
        flutter build apk --release
        
    - name: Upload to Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ secrets.FIREBASE_WORKER_APP_ID }}
        serviceCredentialsFile: firebase-service-account.json
        groups: testers
        file: mobile/worker_app/build/app/outputs/flutter-apk/app-release.apk
        releaseNotes: |
          ğŸš€ Auto-deployed from commit: ${{ github.sha }}
          ğŸ§­ Event: ${{ github.event_name }}
          ğŸ‘¤ By: ${{ github.actor }}
          ğŸ§¾ Run ID: ${{ github.run_id }}
          ğŸ“ Notes: ${{ inputs.notes }}
