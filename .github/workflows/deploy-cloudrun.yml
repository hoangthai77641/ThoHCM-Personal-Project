name: Deploy Backend to Cloud Run

on:
  push:
    branches: [ main ]
    paths: 
      - 'backend/**'
      - 'config/cloudbuild.yaml'
      - '.github/workflows/deploy-cloudrun.yml'
  workflow_dispatch:

env:
  PROJECT_ID: thohcm-application-475603
  SERVICE_NAME: thohcm-backend
  REGION: asia-southeast1

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2

    - name: Verify Authentication
      run: |
        echo "Current authenticated account:"
        gcloud auth list
        echo "Current project:"
        gcloud config get-value project

    - name: Configure Docker to use gcloud
      run: gcloud auth configure-docker

    - name: Build Docker Image
      run: |
        cd backend
        docker build -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} .
        
    - name: Push Docker Image
      run: |
        docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
        
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --region ${{ env.REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --port 8080 \
          --memory 2Gi \
          --cpu 2 \
          --max-instances 3 \
          --min-instances 0 \
          --timeout 300 \
          --no-cpu-throttling \
          --set-env-vars "NODE_ENV=production,GCS_BUCKET_NAME=thohcm-storage,MONGODB_URI=${{ secrets.MONGODB_URI }},JWT_SECRET=${{ secrets.JWT_SECRET }},REDIS_HOST=10.106.178.204,REDIS_PORT=6379,RUN_MIGRATIONS_ON_START=false"
        
    - name: Get Service URL
      id: get-url
      run: |
        URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)")
        echo "url=$URL" >> $GITHUB_OUTPUT
        echo "Backend deployed to: $URL"

    - name: Verify Deployment
      run: |
        echo "Testing health endpoint..."
        curl -f ${{ steps.get-url.outputs.url }}/api/health || exit 1
        echo "âœ… Backend is healthy!"